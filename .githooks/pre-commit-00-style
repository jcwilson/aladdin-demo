#!/usr/bin/env bash
set -eu -o pipefail

# Run static code style analysis in a docker container

# This presumes that you have pointed your docker client at minikube and
# built the pipeline and pipeline-flake8 components.

function check {
    local operation="$1" component="$2"; shift 2

    echo "Checking ${operation} with $* ..."
    poetry run components run "$component" -- "$@"
    echo
}

# Configuration can be found in components/pyproject.yaml [tool.black]
check "code format" pipeline black --check --diff --target-version py38 .

# Configuration can be found in components/pyproject.yaml [tool.isort]
check "import ordering" pipeline isort --settings-path /code/pyproject.toml --check-only --diff

# Configuration can be found in components/prospector.yaml
check "style" pipeline prospector

# Configuration can be found in components/.flake8
check "import ordering and rST docs" pipeline-flake8 flake8
